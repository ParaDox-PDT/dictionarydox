rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is in usersId array
    function hasAccess(usersId) {
      return isAuthenticated() && request.auth.uid in usersId;
    }
    
    // Helper function to check if document is user-specific (not global)
    function isUserSpecific(isGlobal) {
      return isGlobal == false;
    }
    
    // Units collection rules
    match /units/{unitId} {
      // Read: 
      // - If global: any authenticated user can read
      // - If not global: user must be in usersId array
      // Support both old format (userId) and new format (usersId)
      allow read: if isAuthenticated() && (
                     // Global units: anyone can read
                     resource.data.isGlobal == true ||
                     // User-specific units: must be in usersId array
                     (resource.data.isGlobal == false &&
                      (request.auth.uid in resource.data.get('usersId', []) ||
                       resource.data.get('userId', '') == request.auth.uid))
                   );
      
      // Create: User can create if authenticated, includes their userId in usersId array, and isGlobal = false
      allow create: if isAuthenticated() && 
                       request.resource.data.isGlobal == false &&
                       request.resource.data.title is string &&
                       request.resource.data.createdAt is timestamp &&
                       request.resource.data.usersId is list &&
                       request.auth.uid in request.resource.data.usersId;
      
      // Update: User can update if they are in usersId array AND it's not global
      allow update: if isAuthenticated() && 
                       resource.data.isGlobal == false &&
                       request.resource.data.isGlobal == false &&
                       (request.auth.uid in resource.data.get('usersId', []) ||
                        resource.data.get('userId', '') == request.auth.uid) &&
                       request.resource.data.usersId is list &&
                       request.auth.uid in request.resource.data.usersId;
      
      // Delete: User can delete if they are in usersId array AND it's not global
      allow delete: if isAuthenticated() && 
                       resource.data.isGlobal == false &&
                       (request.auth.uid in resource.data.get('usersId', []) ||
                        resource.data.get('userId', '') == request.auth.uid);
    }
    
    // Words collection rules
    match /words/{wordId} {
      // Read: User can read if they own it AND it's not global
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid && 
                     resource.data.isGlobal == false;
      
      // Create: User can create if authenticated, sets their userId, and isGlobal = false
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid && 
                       request.resource.data.isGlobal == false &&
                       request.resource.data.english is string &&
                       request.resource.data.uzbek is string &&
                       request.resource.data.unitId is string &&
                       request.resource.data.createdAt is timestamp;
      
      // Update: User can update if they own it AND it's not global
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid && 
                       resource.data.isGlobal == false &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.isGlobal == false;
      
      // Delete: User can delete if they own it AND it's not global
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid && 
                       resource.data.isGlobal == false;
    }
    
    // Users collection (if you need rules for it)
    match /users/{userId} {
      // Users can read and write their own user document
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
  }
}

