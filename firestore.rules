rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is in usersId array
    function hasAccess(usersId) {
      return isAuthenticated() && request.auth.uid in usersId;
    }
    
    // Helper function to check if document is user-specific (not global)
    function isUserSpecific(isGlobal) {
      return isGlobal == false;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.email == 'doniyorjorabekov@gmail.com';
    }
    
    // Units collection rules
    match /units/{unitId} {
      // Read: 
      // - If global: any authenticated user can read
      // - If not global: user must be in usersId array
      // Support both old format (userId) and new format (usersId)
      allow read: if isAuthenticated() && (
                     // Global units: anyone can read
                     resource.data.isGlobal == true ||
                     // User-specific units: must be in usersId array
                     (resource.data.isGlobal == false &&
                      (request.auth.uid in resource.data.get('usersId', []) ||
                       resource.data.get('userId', '') == request.auth.uid))
                   );
      
      // Create: 
      // - Admin can create global or user-specific units
      // - Regular users can only create user-specific units (isGlobal = false)
      allow create: if isAuthenticated() && 
                       request.resource.data.title is string &&
                       request.resource.data.createdAt is timestamp &&
                       (
                         // Admin can create any unit (global or user-specific)
                         isAdmin() ||
                         // Regular users can only create user-specific units
                         (request.resource.data.isGlobal == false &&
                          request.resource.data.usersId is list &&
                          request.auth.uid in request.resource.data.usersId)
                       );
      
      // Update: 
      // - Admin can update any unit
      // - Regular users can only update user-specific units they have access to
      allow update: if isAuthenticated() && 
                       (
                         // Admin can update any unit
                         isAdmin() ||
                         // Regular users can only update user-specific units they own
                         (resource.data.isGlobal == false &&
                          request.resource.data.isGlobal == false &&
                          (request.auth.uid in resource.data.get('usersId', []) ||
                           resource.data.get('userId', '') == request.auth.uid) &&
                          request.resource.data.usersId is list &&
                          request.auth.uid in request.resource.data.usersId)
                       );
      
      // Delete: 
      // - Admin can delete any unit
      // - Regular users can only delete user-specific units they have access to
      allow delete: if isAuthenticated() && 
                       (
                         // Admin can delete any unit
                         isAdmin() ||
                         // Regular users can only delete user-specific units they own
                         (resource.data.isGlobal == false &&
                          (request.auth.uid in resource.data.get('usersId', []) ||
                           resource.data.get('userId', '') == request.auth.uid))
                       );
    }
    
    // Words collection rules
    match /words/{wordId} {
      // Read: 
      // - Admin can read any word
      // - Global words: any authenticated user can read
      // - User-specific words: user must own them
      allow read: if isAuthenticated() && (
                     // Admin can read any word
                     isAdmin() ||
                     // Global words: anyone can read
                     resource.data.isGlobal == true ||
                     // User-specific words: must own them
                     (resource.data.isGlobal == false &&
                      resource.data.userId == request.auth.uid)
                   );
      
      // Create: 
      // - Admin can create global or user-specific words
      // - Regular users can only create user-specific words
      allow create: if isAuthenticated() && 
                       request.resource.data.english is string &&
                       request.resource.data.uzbek is string &&
                       request.resource.data.unitId is string &&
                       request.resource.data.createdAt is timestamp &&
                       (
                         // Admin can create any word
                         isAdmin() ||
                         // Regular users can only create user-specific words
                         (request.resource.data.userId == request.auth.uid && 
                          request.resource.data.isGlobal == false)
                       );
      
      // Update: 
      // - Admin can update any word
      // - Regular users can only update their own user-specific words
      allow update: if isAuthenticated() && 
                       (
                         // Admin can update any word
                         isAdmin() ||
                         // Regular users can only update their own user-specific words
                         (resource.data.userId == request.auth.uid && 
                          resource.data.isGlobal == false &&
                          request.resource.data.userId == request.auth.uid &&
                          request.resource.data.isGlobal == false)
                       );
      
      // Delete: 
      // - Admin can delete any word
      // - Regular users can only delete their own user-specific words
      allow delete: if isAuthenticated() && 
                       (
                         // Admin can delete any word
                         isAdmin() ||
                         // Regular users can only delete their own user-specific words
                         (resource.data.userId == request.auth.uid && 
                          resource.data.isGlobal == false)
                       );
    }
    
    // Users collection (if you need rules for it)
    match /users/{userId} {
      // Users can read and write their own user document
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
  }
}

